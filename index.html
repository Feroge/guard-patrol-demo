<!DOCTYPE html>
<html>
<head>
  <title>Guard Patrol Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f6f8; }
    h2 { text-align: center; }
    #officer-reader, #point-reader { width: 100%; max-width: 300px; margin: 15px auto; }
    label { font-weight: bold; }
    select { margin-bottom: 20px; }
    a { display: inline-block; margin-top: 20px; }
  </style>
</head>

<body>
<h2>Guard Patrol System</h2>

<label>Site:</label>
<select id="site">
  <option>Site A</option>
  <option>Site B</option>
</select>

<h3>Scan Officer QR</h3>
<div id="officer-reader"></div>

<h3>Scan Patrol Point</h3>
<div id="point-reader"></div>

<a href="report.html">View Patrol Dashboard</a>

<script>
let officer = "";
let scans = JSON.parse(localStorage.getItem("scans") || "[]");

const siteSelect = document.getElementById("site");

const officerScanner = new Html5Qrcode("officer-reader");
const pointScanner = new Html5Qrcode("point-reader");

// --- OFFICER SCAN (ONLY ONCE) ---
officerScanner.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  async text => {
    officer = text;
    alert("Officer logged in: " + officer);
    await officerScanner.stop(); 
    document.getElementById("officer-reader").innerHTML = "<p><b>Officer logged in</b></p>";
  }
);

// --- PATROL POINT SCAN ---
pointScanner.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  async point => {

    if (!officer) {
      alert("Please scan officer QR first");
      return;
    }

    scans.push({
      site: siteSelect.value,
      officer,
      point,
      time: new Date().toLocaleString()
    });

    localStorage.setItem("scans", JSON.stringify(scans));

    alert("Patrol point scanned: " + point);

    // PAUSE scanner briefly to avoid repeated prompts
    await pointScanner.stop();

    setTimeout(() => {
      pointScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        arguments.callee
      );
    }, 2000); // 2-second delay
  }
);
</script>
</body>
</html>
